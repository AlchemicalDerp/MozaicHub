<%- include('../partials/header') %>
<div class="file-hero">
  <div class="file-meta">
    <p class="muted">Visibility: <%= file.visibility %></p>
    <h2><%= file.title %></h2>
    <div class="avatar-row">
      <% if (file.owner.profileImagePath) { %>
        <img class="avatar-sm" src="/uploads/<%= file.owner.profileImagePath %>" alt="<%= file.owner.displayName %>" />
      <% } else { %>
        <div class="avatar-sm placeholder">MH</div>
      <% } %>
      <span class="muted">Uploaded by <%= file.owner.displayName %></span>
    </div>
    <p class="muted"><%= file.description %></p>
    <a class="button" href="/files/<%= file.id %>/download">Download</a>
  </div>
  <div class="media-stage">
    <% if (file.fileCategory === 'audio') { %>
      <audio controls src="/uploads/<%= file.storedFilename %>"></audio>
    <% } else if (file.fileCategory === 'video') { %>
      <video controls src="/uploads/<%= file.storedFilename %>" class="hero-video"></video>
    <% } else if (file.fileCategory === 'image') { %>
      <img src="/uploads/<%= file.storedFilename %>" class="hero-image" />
    <% } else if (file.fileCategory === 'pdf') { %>
      <iframe src="/uploads/<%= file.storedFilename %>" class="pdf-frame"></iframe>
    <% } else { %>
      <div class="download-only">Download-only file.</div>
    <% } %>
  </div>
</div>
<section class="comments">
  <div class="section-head">
    <h3>Comments</h3>
    <p class="muted">Share your thoughts (1000 characters max).</p>
  </div>
  <% if (commentError) { %>
    <div class="alert"><%= commentError %></div>
  <% } %>
  <form method="post" action="/files/<%= file.id %>/comments" class="comment-form">
    <div class="comment-avatar">
      <% if (user.profileImagePath) { %>
        <img class="avatar-sm" src="/uploads/<%= user.profileImagePath %>" alt="Your avatar" />
      <% } else { %>
        <div class="avatar-sm placeholder">You</div>
      <% } %>
    </div>
    <textarea name="text" required maxlength="1000" placeholder="Add a comment..." ></textarea>
    <div class="comment-actions">
      <span class="muted">Markdown supported â€¢ Tag friends with @username</span>
      <button type="submit">Comment</button>
    </div>
  </form>
  <ul class="comment-list">
    <% (file.Comments || []).forEach(comment => { %>
      <li id="comment-<%= comment.id %>">
        <div class="comment-head">
          <% if (comment.author.profileImagePath) { %>
            <img class="avatar-sm" src="/uploads/<%= comment.author.profileImagePath %>" alt="<%= comment.author.displayName %>" />
          <% } else { %>
            <div class="avatar-sm placeholder">MH</div>
          <% } %>
          <div>
            <strong><%= comment.author.displayName %></strong>
            <div class="meta"><%= comment.createdAt.toDateString() %></div>
          </div>
          <% if (comment.authorUserId === user.id || user.role === 'ADMIN' || file.ownerUserId === user.id) { %>
            <form method="post" action="/comments/<%= comment.id %>/delete" class="inline">
              <button type="submit" class="ghost">Delete</button>
            </form>
          <% } %>
        </div>
        <div class="comment-body"><%- comment.renderedText %></div>
      </li>
    <% }) %>
  </ul>
</section>
<%- include('../partials/footer') %>
