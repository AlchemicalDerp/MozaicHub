<%- include('../partials/header') %>
<div class="chat-shell">
  <div class="chat-header">
    <div>
      <p class="meta">Conversation</p>
      <h2><%= peer.displayName %></h2>
    </div>
    <div class="pill">Messages refresh automatically</div>
  </div>
  <div id="chatWindow" class="chat-window">
    <% messages.forEach(m => { %>
      <div class="bubble <%= m.fromUserId === user.id ? 'me' : 'them' %>">
        <div class="bubble-meta"><%= new Date(m.createdAt).toLocaleString() %></div>
        <div class="bubble-body"><%- m.renderedText %></div>
        <% if (m.fromUserId === user.id) { %>
          <div class="bubble-status"><%= m.readAt ? 'Seen' : 'Delivered' %></div>
        <% } %>
      </div>
    <% }) %>
  </div>
  <div id="newMessageToast" class="toast hidden">
    <span>New messages arrived</span>
    <button type="button" class="button secondary" id="jumpToLatest">Jump to latest</button>
  </div>
  <form id="chatForm" class="chat-form" method="post" action="/messages/thread/<%= peerId %>">
    <textarea name="text" id="chatInput" required placeholder="Write a message..." rows="3"></textarea>
    <div class="chat-actions">
      <button type="submit">Send</button>
    </div>
  </form>
</div>
<script>
  const chatWindow = document.getElementById('chatWindow');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const peerId = '<%= peerId %>';
  const toast = document.getElementById('newMessageToast');
  const jumpButton = document.getElementById('jumpToLatest');
  let currentMessages = <%- JSON.stringify(messages) %>;

  function isNearBottom() {
    const distance = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight;
    return distance < 24;
  }

  function renderMessages(list, { fromSend = false } = {}) {
    const wasNearBottom = isNearBottom();
    const previousHeight = chatWindow.scrollHeight;
    const previousTop = chatWindow.scrollTop;
    chatWindow.innerHTML = '';
    list.forEach((m) => {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${m.fromUserId === <%- user.id %> ? 'me' : 'them'}`;
      const meta = document.createElement('div');
      meta.className = 'bubble-meta';
      meta.textContent = new Date(m.createdAt).toLocaleString();
      const body = document.createElement('div');
      body.className = 'bubble-body';
      body.innerHTML = m.renderedText;
      bubble.appendChild(meta);
      bubble.appendChild(body);
      if (m.fromUserId === <%- user.id %>) {
        const status = document.createElement('div');
        status.className = 'bubble-status';
        status.textContent = m.readAt ? 'Seen' : 'Delivered';
        bubble.appendChild(status);
      }
      chatWindow.appendChild(bubble);
    });
    if (wasNearBottom || fromSend) {
      chatWindow.scrollTop = chatWindow.scrollHeight;
      toast.classList.add('hidden');
    } else {
      const newTop = chatWindow.scrollHeight - (previousHeight - previousTop);
      chatWindow.scrollTop = Math.max(newTop, 0);
    }
    currentMessages = list;
  }

  async function refreshMessages() {
    const res = await fetch(`/messages/thread/${peerId}/data`);
    if (!res.ok) return;
    const data = await res.json();
    const gotNewMessage = data.length > currentMessages.length;
    renderMessages(data);
    if (gotNewMessage && !isNearBottom()) {
      toast.classList.remove('hidden');
    }
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;
    const res = await fetch(`/messages/thread/${peerId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ text })
    });
    if (res.ok) {
      const data = await res.json();
      renderMessages(data, { fromSend: true });
      chatInput.value = '';
      chatInput.focus();
    }
  });

  jumpButton.addEventListener('click', () => {
    chatWindow.scrollTop = chatWindow.scrollHeight;
    toast.classList.add('hidden');
  });

  setInterval(refreshMessages, 3000);
  renderMessages(currentMessages, { fromSend: true });
</script>
<%- include('../partials/footer') %>
