<script>
  const body = document.body;
  const toggle = document.getElementById('themeToggle');
  const stored = localStorage.getItem('theme');
  if (stored === 'light') { body.classList.remove('theme-dark'); body.classList.add('theme-light'); }
  toggle?.addEventListener('click', () => {
    const isDark = body.classList.toggle('theme-dark');
    if (!isDark) { body.classList.add('theme-light'); localStorage.setItem('theme', 'light'); }
    else { body.classList.remove('theme-light'); localStorage.setItem('theme', 'dark'); }
  });

  document.querySelectorAll('form[data-confirm]').forEach(form => {
    form.addEventListener('submit', (event) => {
      const message = form.getAttribute('data-confirm') || 'Are you sure you want to continue?';
      if (!confirm(message)) {
        event.preventDefault();
      }
    });
  });

  const notifToggle = document.getElementById('notifToggle');
  const notifPanel = document.getElementById('notifPanel');
  const notifList = document.getElementById('notifList');
  const notifBadge = document.getElementById('notifBadge');
  const notifWrap = document.querySelector('.notification-wrap');
  let unreadIds = [];
  let notifOpen = false;

  function renderNotifications(items) {
    if (!notifList) return;
    notifList.innerHTML = '';
    if (!items.length) {
      const empty = document.createElement('li');
      empty.className = 'meta';
      empty.textContent = 'Nothing new right now.';
      notifList.appendChild(empty);
      return;
    }
    items.forEach((n) => {
      const li = document.createElement('li');
      li.className = n.readAt ? '' : 'unread';
      li.innerHTML = `<div>${n.message}</div><div class="meta">${new Date(n.createdAt).toLocaleString()}</div>`;
      if (n.link) {
        const link = document.createElement('a');
        link.href = n.link;
        link.textContent = 'Open';
        link.className = 'small';
        link.style.display = 'inline-block';
        link.style.marginTop = '6px';
        li.appendChild(link);
      }
      notifList.appendChild(li);
    });
  }

  async function loadNotifications() {
    if (!notifList) return;
    const res = await fetch('/notifications/panel');
    if (!res.ok) return;
    const data = await res.json();
    unreadIds = data.filter((n) => !n.readAt).map((n) => n.id);
    renderNotifications(data);
  }

  async function clearSeenNotifications() {
    if (!unreadIds.length) return;
    await fetch('/notifications/mark-read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: unreadIds }),
    });
    unreadIds = [];
    if (notifBadge) {
      notifBadge.textContent = '';
      notifBadge.style.display = 'none';
    }
    if (notifList) {
      notifList.innerHTML = '';
    }
  }

  function closePanel(markSeen = true) {
    if (!notifPanel || !notifOpen) return;
    notifPanel.classList.remove('visible');
    notifOpen = false;
    if (markSeen) clearSeenNotifications();
  }

  notifToggle?.addEventListener('click', async (event) => {
    event.stopPropagation();
    if (notifOpen) {
      closePanel(true);
      return;
    }
    notifOpen = true;
    notifPanel?.classList.add('visible');
    await loadNotifications();
  });

  document.addEventListener('click', (event) => {
    if (!notifOpen) return;
    if (notifWrap && notifWrap.contains(event.target)) return;
    closePanel(true);
  });
</script>
</div>
</body>
</html>
